<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real Database CSV Export Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .button {
        background: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
      }
      .button:hover {
        background: #0056b3;
      }
      .output {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin: 15px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        color: #28a745;
      }
      .error {
        color: #dc3545;
      }
      .info {
        color: #17a2b8;
      }
      .warning {
        color: #ffc107;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Course Mark Management System</h1>
      <h2>Real Database CSV Export Test</h2>

      <p>
        This page tests the enhanced CSV export functionality that connects to
        the real MySQL database.
      </p>

      <div>
        <button class="button" onclick="testDatabaseConnection()">
          Test Database Connection
        </button>
        <button class="button" onclick="testRealDataExport()">
          Test Real Data CSV Export
        </button>
        <button class="button" onclick="testAPIEndpoints()">
          Test All API Endpoints
        </button>
        <button class="button" onclick="clearOutput()">Clear Output</button>
      </div>

      <div id="output" class="output">
        Click a button above to start testing...
      </div>
    </div>

    <script>
      const output = document.getElementById("output");

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const colorClass =
          type === "success"
            ? "success"
            : type === "error"
            ? "error"
            : type === "warning"
            ? "warning"
            : "info";
        output.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
        output.scrollTop = output.scrollHeight;
      }

      function clearOutput() {
        output.innerHTML = "Output cleared...\n";
      }

      async function testDatabaseConnection() {
        log("=== Testing Database Connection ===", "info");

        try {
          log("Attempting to connect to database...", "info");

          const response = await fetch("http://localhost:8080/db-api.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify({
              email: "lecturer1@example.com",
              password: "password",
            }),
          });

          const data = await response.json();

          if (data.user) {
            log("✅ Database connection successful!", "success");
            log(`User: ${data.user.name} (${data.user.role})`, "success");
            log(`Token received: ${data.token ? "Yes" : "No"}`, "info");

            // Store credentials for other tests
            localStorage.setItem("token", data.token);
            localStorage.setItem("user", JSON.stringify(data.user));
          } else {
            log("❌ Database connection failed", "error");
            log(`Error: ${data.message || "Unknown error"}`, "error");
          }
        } catch (error) {
          log(`❌ Connection error: ${error.message}`, "error");
        }
      }

      async function testRealDataExport() {
        log("=== Testing Real Database CSV Export ===", "info");

        try {
          // Check if user is logged in
          const user = JSON.parse(localStorage.getItem("user") || "null");
          if (!user) {
            log("⚠️ Please test database connection first", "warning");
            return;
          }

          log(`Testing as: ${user.name} (${user.role})`, "info");

          // Get courses
          log("Fetching courses...", "info");
          const coursesResponse = await fetch(
            `http://localhost:8080/marks-api.php?action=lecturer_courses&lecturer_id=${user.id}`,
            {
              credentials: "include",
            }
          );

          const coursesData = await coursesResponse.json();
          log(`Found ${coursesData.courses?.length || 0} courses`, "info");

          if (coursesData.courses && coursesData.courses.length > 0) {
            const course = coursesData.courses[0];
            log(`Testing with course: ${course.code} - ${course.name}`, "info");

            // Get students and marks
            log("Fetching student marks...", "info");
            const marksResponse = await fetch(
              `http://localhost:8080/marks-api.php?action=course_students_marks&course_id=${course.id}`,
              {
                credentials: "include",
              }
            );

            const marksData = await marksResponse.json();
            log(`Found ${marksData.students?.length || 0} students`, "info");

            if (marksData.students && marksData.students.length > 0) {
              // Create enhanced CSV
              log("Creating enhanced CSV export...", "info");

              const csvLines = [];

              // Header
              csvLines.push(
                "COURSE MARK MANAGEMENT SYSTEM - REAL DATABASE EXPORT"
              );
              csvLines.push("");
              csvLines.push("COURSE INFORMATION");
              csvLines.push(`Course Code,${course.code}`);
              csvLines.push(`Course Name,"${course.name}"`);
              csvLines.push(`Export Date,${new Date().toLocaleDateString()}`);
              csvLines.push(`Export Time,${new Date().toLocaleTimeString()}`);
              csvLines.push(`Total Students,${marksData.students.length}`);
              csvLines.push("");

              // Student data
              csvLines.push("STUDENT MARKS");
              csvLines.push(
                "Student Name,Email,Assignment,Quiz,Test,Final Exam,Final Mark,Grade"
              );

              let totalMarks = 0;
              let studentsWithMarks = 0;

              marksData.students.forEach((student) => {
                const marks = student.marks || {};

                // Calculate final mark (simplified calculation)
                const assignment = parseFloat(marks.assignment) || 0;
                const quiz = parseFloat(marks.quiz) || 0;
                const test = parseFloat(marks.test) || 0;
                const finalExam = parseFloat(marks.final_exam) || 0;

                const finalMark =
                  assignment * 0.25 +
                  quiz * 0.2 +
                  test * 0.25 +
                  finalExam * 0.3;

                let grade = "F";
                if (finalMark >= 80) grade = "A";
                else if (finalMark >= 70) grade = "B";
                else if (finalMark >= 60) grade = "C";
                else if (finalMark >= 50) grade = "D";

                if (finalMark > 0) {
                  totalMarks += finalMark;
                  studentsWithMarks++;
                }

                csvLines.push(
                  `"${student.name}","${
                    student.email || "N/A"
                  }",${assignment},${quiz},${test},${finalExam},${finalMark.toFixed(
                    2
                  )},${grade}`
                );
              });

              // Statistics
              csvLines.push("");
              csvLines.push("STATISTICS");
              if (studentsWithMarks > 0) {
                csvLines.push(
                  `Class Average,${(totalMarks / studentsWithMarks).toFixed(2)}`
                );
              }
              csvLines.push(`Export Generated,${new Date().toISOString()}`);

              // Create and download CSV
              const csvContent = csvLines.join("\\n");
              const blob = new Blob([csvContent], {
                type: "text/csv;charset=utf-8",
              });
              const url = window.URL.createObjectURL(blob);
              const link = document.createElement("a");

              link.href = url;
              link.download = `${course.code}_Real_Database_Export_${
                new Date().toISOString().split("T")[0]
              }.csv`;

              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              window.URL.revokeObjectURL(url);

              log("✅ Real database CSV export successful!", "success");
              log(`File: ${link.download}`, "success");
              log(
                `Lines: ${csvLines.length}, Size: ${csvContent.length} chars`,
                "info"
              );
            } else {
              log("❌ No student data found", "error");
            }
          } else {
            log("❌ No courses found for this lecturer", "error");
          }
        } catch (error) {
          log(`❌ Export error: ${error.message}`, "error");
        }
      }

      async function testAPIEndpoints() {
        log("=== Testing All API Endpoints ===", "info");

        const endpoints = [
          {
            name: "Database Connection",
            url: "http://localhost:8080/db-api.php",
            method: "POST",
            body: { email: "lecturer1@example.com", password: "password" },
          },
          {
            name: "Lecturer Courses",
            url: "http://localhost:8080/marks-api.php?action=lecturer_courses&lecturer_id=2",
            method: "GET",
          },
          {
            name: "Student Marks",
            url: "http://localhost:8080/marks-api.php?action=course_students_marks&course_id=1",
            method: "GET",
          },
        ];

        for (const endpoint of endpoints) {
          try {
            log(`Testing: ${endpoint.name}...`, "info");

            const options = {
              method: endpoint.method,
              credentials: "include",
              headers: { "Content-Type": "application/json" },
            };

            if (endpoint.body) {
              options.body = JSON.stringify(endpoint.body);
            }

            const response = await fetch(endpoint.url, options);
            const data = await response.json();

            if (response.ok && data) {
              log(`✅ ${endpoint.name}: Success`, "success");

              // Log specific results
              if (data.user) log(`  User: ${data.user.name}`, "info");
              if (data.courses)
                log(`  Courses: ${data.courses.length}`, "info");
              if (data.students)
                log(`  Students: ${data.students.length}`, "info");
            } else {
              log(`❌ ${endpoint.name}: Failed`, "error");
              log(`  Status: ${response.status}`, "error");
            }
          } catch (error) {
            log(`❌ ${endpoint.name}: ${error.message}`, "error");
          }
        }

        log("=== API Testing Complete ===", "info");
      }

      // Auto-test on page load
      log("Real Database CSV Export Test Page Loaded", "success");
      log("Backend should be running on: http://localhost:8080", "info");
      log("Frontend should be running on: http://localhost:8082", "info");
    </script>
  </body>
</html>
